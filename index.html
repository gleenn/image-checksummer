<!DOCTYPE HTML>
<html>
<head>
    <script src="vendor/jquery.js"></script>
    <script src="vendor/underscore.js"></script>
    <script src="vendor/underscore-enhancements/underscore-enhancements.js"></script>
    <script>
        ImageChecksumer = function(imageBlock) {
            var self = this;
            self.imageBlock = imageBlock;
            self.image = new Image();
            self.origImage = $(imageBlock).find("img").get(0);
            self.canvas = $(imageBlock).find("canvas").get(0);
            self.context = self.canvas.getContext("2d");

            $(self.image).load(function() {
                self.canvas.setAttribute("height", self.origImage.height);
                self.canvas.setAttribute("width", self.origImage.width);
                self.context.drawImage(self.image, 0, 0);
            });

            self.image.src = self.origImage.src;

            self.checksum = function(callback) {
                $(self.image).load(function() {
                    var dataz = self.context.getImageData(0, 0, self.image.width - 1, self.image.height - 1).data;
                    callback(sum(dataz));
                });
            };
            return self;

            function sum(data) {
                var avgRed = 0;
                var avgGreen = 0;
                var avgBlue = 0;

                for (var i = 0; i < data.length; i += 4) {
                    avgRed += data[i];
                    avgGreen += data[i + 1];
                    avgBlue += data[i + 2];
                }

                var numPixels = data.length / 4;
                var result = [avgRed / numPixels, avgGreen / numPixels, avgBlue / numPixels];
                return result;
            }
        };

        $(function() {
            $.each($(".img_block"), function(index, imgBlock) {
                new ImageChecksumer($(imgBlock)).checksum(function(sum) {
                    $(imgBlock).append("<p>checksum: " + sum + "</p>");
                });
            });
        });

    </script>
    <style type="text/css">
    </style>
</head>
<body>
<div class="img_block"><img src="large_flowers.jpg"/>
    <canvas></canvas>
</div>
<div class="img_block"><img src="medium_flowers.jpg"/>
    <canvas></canvas>
</div>
<div class="img_block"><img src="small_flowers.jpg"/>
    <canvas></canvas>
</div>
</body>
</html>
